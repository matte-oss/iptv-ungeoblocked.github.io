<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ungeoblocked IPTV</title>
  <link href="https://unpkg.com/video.js@7.11.4/dist/video-js.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    .country { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    button { background: #0366d6; color: white; border: none; padding: 8px 12px; cursor: pointer; }
    #player-container { margin: 20px 0; background: #000; }
  </style>
</head>
<body>
  <h1>🌍 Ungeoblocked IPTV</h1>
  <p>🚫 <em>Disclaimer: No paid channels/piracy support. Streams may require DRM-compatible players.</em></p>

  <div id="countries-container">
    <!-- Popolato dinamicamente da JS -->
  </div>

  <div id="player-container">
    <video id="iptv-player" class="video-js vjs-default-skin" controls width="640" height="360"></video>
  </div>

  <script src="https://unpkg.com/video.js@7.11.4/dist/video.min.js"></script>
  <script src="https://unpkg.com/@videojs/http-streaming@2.9.0/dist/videojs-http-streaming.min.js"></script>
  <script>
    // Configurazione
    const REPO = "matte-oss/iptv-ungeoblocked";
    const COUNTRIES = [
      { code: "UK", name: "United Kingdom", flag: "🇬🇧" },
      { code: "IT", name: "Italy", flag: "🇮🇹" },
      { code: "CH", name: "Switzerland", flag: "🇨🇭" },
      { code: "US", name: "United States", flag: "🇺🇸" }
    ];

    // Inizializza player
    const player = videojs('iptv-player', { html5: { vhs: { overrideNative: true } } });

    // Fetcha i dati dal repo
    async function loadCountryData(countryCode) {
      const [channels, m3u] = await Promise.all([
        fetch(`https://raw.githubusercontent.com/${REPO}/main/ch-list/${countryCode.toLowerCase()}.md`).then(res => res.text()),
        fetch(`https://raw.githubusercontent.com/${REPO}/main/countries/${countryCode}.m3u`).then(res => res.text())
      ]);
      return { channels, m3u };
    }

    // Parsa i canali dal file .m3u
    function parseM3U(m3uText) {
      const channels = [];
      const lines = m3uText.split('\n');
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const nameMatch = lines[i].match(/tvg-name="([^"]+)"/);
          const logoMatch = lines[i].match(/tvg-logo="([^"]+)"/);
          const url = lines[i+1];
          if (nameMatch && url) {
            channels.push({
              name: nameMatch[1],
              logo: logoMatch ? logoMatch[1] : null,
              url: url.trim()
            });
          }
        }
      }
      return channels;
    }

    // Genera la UI
    async function renderPage() {
      const container = document.getElementById('countries-container');
      
      for (const country of COUNTRIES) {
        const { channels, m3u } = await loadCountryData(country.code);
        const channelList = parseM3U(m3u);
        
        const countryHTML = `
          <div class="country">
            <h2>${country.flag} ${country.name}</h2>
            <button onclick="copyToClipboard('https://tinyurl.com/ungeo${country.code.toLowerCase()}')">
              Copy ${country.code} Playlist URL
            </button>
            <div class="channels">
              <h3>Channels:</h3>
              <ul>
                ${channelList.slice(0, 5).map(ch => `
                  <li>
                    <img src="${ch.logo || 'https://via.placeholder.com/50'}" width="50">
                    <button onclick="playStream('${ch.url}', '${ch.name}')">${ch.name}</button>
                  </li>
                `).join('')}
              </ul>
              <p><a href="ch-list/${country.code.toLowerCase()}.md">📺 View Full Channel List</a></p>
            </div>
          </div>
        `;
        container.innerHTML += countryHTML;
      }
    }

    // Funzioni di utilità
    function playStream(url, name) {
      player.src({ src: url, type: url.includes('.mpd') ? 'application/dash+xml' : 'application/x-mpegURL' });
      player.play();
      document.querySelector('#player-container h3')?.remove();
      const title = document.createElement('h3');
      title.textContent = `Now Playing: ${name}`;
      document.getElementById('player-container').prepend(title);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => alert('URL copied!'));
    }

    // Avvia tutto
    renderPage();
  </script>
</body>
</html>
